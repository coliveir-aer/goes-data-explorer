<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">

    <title>GOES Data Explorer</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f0f4f8;
            display: flex;
            justify-content: center;
            align-items: flex-start; /* Align to top for better content flow */
            min-height: 100vh;
            padding: 20px;
            box-sizing: border-box;
        }
        .container {
            background-color: #ffffff;
            border-radius: 12px;
            box-shadow: 0 10px 25px rgba(0, 0, 0, 0.1);
            padding: 32px;
            width: 100%;
            max-width: 800px; /* Increased max-width for better layout with buttons */
            box-sizing: border-box;
            margin-top: 50px; /* Add some top margin */
        }
        .form-group label {
            font-weight: 600;
            color: #334155;
            margin-bottom: 8px;
            display: block;
        }
        .form-group select,
        .form-group input[type="date"] {
            width: 100%;
            padding: 12px 16px;
            border: 1px solid #cbd5e1;
            border-radius: 8px;
            font-size: 1rem;
            color: #334155;
            background-color: #f8fafc;
            transition: border-color 0.2s ease-in-out, box-shadow 0.2s ease-in-out;
        }
        .form-group select:focus,
        .form-group input[type="date"]:focus {
            outline: none;
            border-color: #3b82f6;
            box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.25);
        }
        .btn-primary {
            background-color: #3b82f6;
            color: white;
            padding: 12px 24px;
            border-radius: 8px;
            font-weight: 600;
            cursor: pointer;
            transition: background-color 0.2s ease-in-out, transform 0.1s ease-in-out;
            box-shadow: 0 4px 10px rgba(59, 130, 246, 0.3);
        }
        .btn-primary:hover {
            background-color: #2563eb;
            transform: translateY(-1px);
        }
        .btn-primary:active {
            transform: translateY(0);
            box-shadow: 0 2px 5px rgba(59, 130, 246, 0.3);
        }
        .results-area {
            background-color: #f8fafc;
            border: 1px solid #e2e8f0;
            border-radius: 8px;
            padding: 16px;
            min-height: 150px;
            max-height: 400px; /* Limit height for scrollability */
            overflow-y: auto;
            color: #334155;
            font-family: 'SFMono-Regular', Consolas, 'Liberation Mono', Menlo, Courier, monospace;
            font-size: 0.9rem;
            line-height: 1.5;
            white-space: pre-wrap; /* Preserve whitespace and wrap text */
            word-break: break-all; /* Break long words */
        }
        .loading-spinner {
            border: 4px solid rgba(0, 0, 0, 0.1);
            border-left-color: #3b82f6;
            border-radius: 50%;
            width: 24px;
            height: 24px;
            animation: spin 1s linear infinite;
            display: none; /* Hidden by default */
            margin-left: 12px;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        .error-message {
            color: #ef4444;
            background-color: #fef2f2;
            border: 1px solid #fecaca;
            border-radius: 8px;
            padding: 12px;
            margin-top: 16px;
            display: none;
        }

        /* Custom radio button styling */
        .radio-group {
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
        }
        .radio-group label {
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 10px 16px;
            border: 1px solid #cbd5e1;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.2s ease-in-out;
            background-color: #f8fafc;
            color: #475569;
            font-weight: 500;
            flex-grow: 1; /* Allow items to grow to fill space */
            text-align: center;
        }
        .radio-group input[type="radio"] {
            display: none; /* Hide the actual radio button */
        }
        .radio-group input[type="radio"]:checked + label {
            background-color: #3b82f6;
            color: white;
            border-color: #3b82f6;
            box-shadow: 0 2px 5px rgba(59, 130, 246, 0.3);
        }
        .radio-group label:hover {
            border-color: #93c5fd;
            background-color: #e0f2fe;
        }
        .radio-group input[type="radio"]:checked + label:hover {
            background-color: #2563eb;
        }
        .radio-group.coverage-region label,
        .radio-group.satellite-selection label {
            min-width: 100px; /* Ensure consistent width for regions/satellites */
        }

        /* Style for selectable list items */
        .selectable-list-item {
            display: flex;
            align-items: center;
            padding: 8px 0;
            border-bottom: 1px solid #e2e8f0;
        }
        .selectable-list-item:last-child {
            border-bottom: none;
        }
        .selectable-list-item input[type="checkbox"] {
            margin-right: 10px;
            transform: scale(1.2); /* Make checkbox slightly larger */
            cursor: pointer;
        }
        .selectable-list-item span {
            flex-grow: 1;
            word-break: break-all;
        }

        /* Channel selection grid */
        .channel-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(60px, 1fr));
            gap: 8px;
            margin-top: 10px;
        }
        .channel-grid label {
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 8px 0;
            border: 1px solid #cbd5e1;
            border-radius: 6px;
            cursor: pointer;
            transition: all 0.2s ease-in-out;
            background-color: #f8fafc;
            color: #475569;
            font-weight: 500;
        }
        .channel-grid input[type="checkbox"] {
            display: none;
        }
        .channel-grid input[type="checkbox"]:checked + label {
            background-color: #3b82f6;
            color: white;
            border-color: #3b82f6;
            box-shadow: 0 2px 5px rgba(59, 130, 246, 0.3);
        }
        .channel-grid label:hover {
            border-color: #93c5fd;
            background-color: #e0f2fe;
        }
        .channel-grid input[type="checkbox"]:checked + label:hover {
            background-color: #2563eb;
        }

        /* Styles for the info pane */
        .info-pane details {
            background-color: #eff6ff; /* Light blue background */
            border: 1px solid #bfdbfe; /* Blue border */
            border-radius: 8px;
            padding: 16px;
            margin-top: 24px;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.05);
        }
        .info-pane summary {
            font-weight: 600;
            color: #1e40af; /* Darker blue for summary text */
            cursor: pointer;
            list-style: none; /* Hide default arrow */
            display: flex;
            align-items: center;
        }
        .info-pane summary::-webkit-details-marker {
            display: none; /* Hide default arrow for Webkit browsers */
        }
        .info-pane summary::before {
            content: '▶'; /* Custom arrow */
            margin-right: 8px;
            transition: transform 0.2s ease-in-out;
        }
        .info-pane details[open] summary::before {
            content: '▼'; /* Custom arrow when open */
            transform: rotate(90deg);
        }
        .info-pane ul {
            list-style: disc;
            margin-left: 20px;
            margin-top: 10px;
            color: #334155;
            font-size: 0.9rem;
        }
        .info-pane ul ul { /* Nested lists */
            list-style: circle;
            margin-left: 20px;
        }
        .info-pane p {
            margin-top: 10px;
            font-size: 0.9rem;
            color: #334155;
        }
        .info-pane table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 12px;
            font-size: 0.85rem;
        }
        .info-pane th, .info-pane td {
            border: 1px solid #cbd5e1;
            padding: 8px;
            text-align: left;
        }
        .info-pane th {
            background-color: #e0f2fe;
            font-weight: 600;
            color: #1e40af;
        }
        .info-pane tr:nth-child(even) {
            background-color: #f8fafc;
        }

        /* Styles for copy link section */
        .copy-link-group {
            display: flex;
            gap: 8px;
            margin-top: 16px;
        }
        .copy-link-group input[type="text"] {
            flex-grow: 1;
            padding: 10px 12px;
            border: 1px solid #cbd5e1;
            border-radius: 8px;
            font-size: 0.9rem;
            background-color: #f8fafc;
            color: #334155;
        }
        .copy-link-group button {
            background-color: #10b981; /* Green for copy */
            color: white;
            padding: 10px 16px;
            border-radius: 8px;
            font-weight: 600;
            cursor: pointer;
            transition: background-color 0.2s ease-in-out;
            white-space: nowrap; /* Prevent text wrapping */
        }
        .copy-link-group button:hover {
            background-color: #059669;
        }
        
        /* NEW STYLES ADDED FOR JSON AND COPY PANELS */
        #jsonOutputPanel, #copyLinksPanel {
            margin-top: 24px;
            padding: 16px;
            background-color: #f8fafc;
            border: 1px solid #e2e8f0;
            border-radius: 8px;
        }
        #jsonDisplayArea {
             width: 100%;
             height: 150px;
             padding: 12px;
             margin-bottom: 12px;
             font-family: 'SFMono-Regular', Consolas, 'Liberation Mono', Menlo, Courier, monospace;
             font-size: 0.9rem;
             border: 1px solid #cbd5e1;
             border-radius: 8px;
             background-color: white;
             resize: vertical;
        }
        .message-box {
            border-radius: 8px;
            padding: 12px;
            margin-top: 16px;
            transition: opacity 0.3s ease-in-out;
        }

    </style>
    <script async src="https://www.googletagmanager.com/gtag/js?id=G-S1GZVR1HPX"></script>
    <script>
      window.dataLayer = window.dataLayer || [];
      function gtag(){dataLayer.push(arguments);}
      gtag('js', new Date());
      
      gtag('config', 'G-S1GZVR1HPX');
    </script>
</head>

<body class="antialiased">
    <div class="container">
        <h1 class="text-3xl font-bold text-center text-gray-800 mb-8">GOES Data Explorer</h1>

        <div class="form-group mb-6">
            <label class="mb-2">Satellite:</label>
            <div id="satelliteSelectionRadios" class="radio-group satellite-selection">
                </div>
        </div>

        <div class="form-group mb-6">
            <label for="productTypeSelect" class="mb-2">Product Type:</label>
            <select id="productTypeSelect" class="focus:ring-blue-500 focus:border-blue-500">
                </select>
        </div>

        <div class="info-pane mb-6">
            <details>
                <summary>Product Type Mapping Cheat Sheet</summary>
                <div class="content mt-2">
                    <p class="mb-4">This cheat sheet explains how the display names in the "Product Type" dropdown map to the actual S3 directory paths and file naming conventions. If you encounter any discrepancies or missing products, please report them to the <a href="https://github.com/coliveir-aer/goes-data-explorer/issues" target="_blank" class="text-blue-600 hover:text-blue-800 font-semibold transition-colors duration-200">GOES Data Explorer GitHub Issues</a>.</p>

                    <h4 class="font-semibold text-gray-700 mb-2">Product Type to S3 Base Name Mapping:</h4>
                    <table class="w-full text-left table-auto border border-collapse border-gray-300 rounded-lg overflow-hidden">
                        <thead>
                            <tr>
                                <th class="px-4 py-2 bg-blue-100 text-blue-800">Display Name</th>
                                <th class="px-4 py-2 bg-blue-100 text-blue-800">S3 Base Product Code</th>
                            </tr>
                        </thead>
                        <tbody>
                            <tr><td class="px-4 py-2">ABI L1b Radiance</td><td class="px-4 py-2">ABI-L1b-Rad</td></tr>
                            <tr><td class="px-4 py-2">ABI L2 Cloud Top Height</td><td class="px-4 py-2">ABI-L2-ACHA</td></tr>
                            <tr><td class="px-4 py-2">ABI L2 2km Cloud Height</td><td class="px-4 py-2">ABI-L2-ACHA2KM</td></tr>
                            <tr><td class="px-4 py-2">ABI L2 2km Cloud Pressure</td><td class="px-4 py-2">ABI-L2-ACHP2KM</td></tr>
                            <tr><td class="px-4 py-2">ABI L2 Cloud Top Temperature</td><td class="px-4 py-2">ABI-L2-ACHT</td></tr>
                            <tr><td class="px-4 py-2">ABI L2 Cloud Mask</td><td class="px-4 py-2">ABI-L2-ACM</td></tr>
                            <tr><td class="px-4 py-2">ABI L2 Cloud Top Phase</td><td class="px-4 py-2">ABI-L2-ACTP</td></tr>
                            <tr><td class="px-4 py-2">ABI L2 Aerosol Detection</td><td class="px-4 py-2">ABI-L2-ADP</td></tr>
                            <tr><td class="px-4 py-2">ABI L2 Ice Conc & Extent</td><td class="px-4 py-2">ABI-L2-AICE</td></tr>
                            <tr><td class="px-4 py-2">ABI L2 Ice Thickness & Age</td><td class="px-4 py-2">ABI-L2-AITA</td></tr>
                            <tr><td class="px-4 py-2">ABI L2 Aerosol Optical Depth</td><td class="px-4 py-2">ABI-L2-AOD</td></tr>
                            <tr><td class="px-4 py-2">ABI L2 Bidirectional Reflectance</td><td class="px-4 py-2">ABI-L2-BRF</td></tr>
                            <tr><td class="px-4 py-2">ABI L2 Clear Sky Confidence</td><td class="px-4 py-2">ABI-L2-CCLC</td></tr>
                            <tr><td class="px-4 py-2">ABI L2 Cloud & Moisture Imagery</td><td class="px-4 py-2">ABI-L2-CMIP</td></tr>
                            <tr><td class="px-4 py-2">ABI L2 Cloud Optical Depth</td><td class="px-4 py-2">ABI-L2-COD</td></tr>
                            <tr><td class="px-4 py-2">ABI L2 Cloud Optical Depth 2KM</td><td class="px-4 py-2">ABI-L2-COD2KM</td></tr>
                            <tr><td class="px-4 py-2">ABI L2 Cloud Particle Size</td><td class="px-4 py-2">ABI-L2-CPS</td></tr>
                            <tr><td class="px-4 py-2">ABI L2 Cloud Top Pressure</td><td class="px-4 py-2">ABI-L2-CTP</td></tr>
                            <tr><td class="px-4 py-2">ABI L2 Derived Motion Winds</td><td class="px-4 py-2">ABI-L2-DMW</td></tr>
                            <tr><td class="px-4 py-2">ABI L2 Derived Motion Wind Vectors</td><td class="px-4 py-2">ABI-L2-DMWV</td></tr>
                            <tr><td class="px-4 py-2">ABI L2 Derived Stability Indices</td><td class="px-4 py-2">ABI-L2-DSI</td></tr>
                            <tr><td class="px-4 py-2">ABI L2 Downward Shortwave Radiation</td><td class="px-4 py-2">ABI-L2-DSR</td></tr>
                            <tr><td class="px-4 py-2">ABI L2 Fire/Hot Spot</td><td class="px-4 py-2">ABI-L2-FDC</td></tr>
                            <tr><td class="px-4 py-2">ABI L2 Fractional Snow Cover</td><td class="px-4 py-2">ABI-L2-FSC</td></tr>
                            <tr><td class="px-4 py-2">ABI L2 Land Surface Albedo</td><td class="px-4 py-2">ABI-L2-LSA</td></tr>
                            <tr><td class="px-4 py-2">ABI L2 Land Surface Temperature</td><td class="px-4 py-2">ABI-L2-LST</td></tr>
                            <tr><td class="px-4 py-2">ABI L2 Land Surface Temperature 2KM</td><td class="px-4 py-2">ABI-L2-LST2KM</td></tr>
                            <tr><td class="px-4 py-2">ABI L2 Legacy Vertical Moisture Profile</td><td class="px-4 py-2">ABI-L2-LVMP</td></tr>
                            <tr><td class="px-4 py-2">ABI L2 Legacy Vertical Temp Profile</td><td class="px-4 py-2">ABI-L2-LVTP</td></tr>
                            <tr><td class="px-4 py-2">ABI L2 Imagery 16 Channel</td><td class="px-4 py-2">ABI-L2-MCMIP</td></tr>
                            <tr><td class="px-4 py-2">ABI L2 Photosynthetically Active Radiation</td><td class="px-4 py-2">ABI-L2-PAR</td></tr>
                            <tr><td class="px-4 py-2">ABI L2 Rainfall Rate QPE</td><td class="px-4 py-2">ABI-L2-RRQPE</td></tr>
                            <tr><td class="px-4 py-2">ABI L2 Reflected Shortwave Radiation Top-of-Atmosphere</td><td class="px-4 py-2">ABI-L2-RSR</td></tr>
                            <tr><td class="px-4 py-2">ABI L2 Sea Surface Temperature</td><td class="px-4 py-2">ABI-L2-SST</td></tr>
                            <tr><td class="px-4 py-2">ABI L2 Total Precipitable Water</td><td class="px-4 py-2">ABI-L2-TPW</td></tr>
                            <tr><td class="px-4 py-2">EXIS L1b Solar Flux EUV</td><td class="px-4 py-2">EXIS-L1b-SFEU</td></tr>
                            <tr><td class="px-4 py-2">EXIS L1b Solar Flux X-Ray</td><td class="px-4 py-2">EXIS-L1b-SFXR</td></tr>
                            <tr><td class="px-4 py-2">GLM L2 Lightning</td><td class="px-4 py-2">GLM-L2-LCFA</td></tr>
                            <tr><td class="px-4 py-2">MAG L1b Geomagnetic Field</td><td class="px-4 py-2">MAG-L1b-GEOF</td></tr>
                            <tr><td class="px-4 py-2">SEIS L1b Energetic Heavy Ion Sensor</td><td class="px-4 py-2">SEIS-L1b-EHIS</td></tr>
                            <tr><td class="px-4 py-2">SEIS L1b Magnetospheric Particle Sensor High</td><td class="px-4 py-2">SEIS-L1b-MPSH</td></tr>
                            <tr><td class="px-4 py-2">SEIS L1b Magnetospheric Particle Sensor Low</td><td class="px-4 py-2">SEIS-L1b-MPSL</td></tr>
                            <tr><td class="px-4 py-2">SEIS L1b Solar and Galactic Proton Sensor</td><td class="px-4 py-2">SEIS-L1b-SGPS</td></tr>
                            <tr><td class="px-4 py-2">SUVI L1b Fe093</td><td class="px-4 py-2">SUVI-L1b-Fe093</td></tr>
                            <tr><td class="px-4 py-2">SUVI L1b Fe131</td><td class="px-4 py-2">SUVI-L1b-Fe131</td></tr>
                            <tr><td class="px-4 py-2">SUVI L1b Fe171</td><td class="px-4 py-2">SUVI-L1b-Fe171</td></tr>
                            <tr><td class="px-4 py-2">SUVI L1b Fe195</td><td class="px-4 py-2">SUVI-L1b-Fe195</td></tr>
                            <tr><td class="px-4 py-2">SUVI L1b Fe284</td><td class="px-4 py-2">SUVI-L1b-Fe284</td></tr>
                            <tr><td class="px-4 py-2">SUVI L1b He303</td><td class="px-4 py-2">SUVI-L1b-He303</td></tr>
                        </tbody>
                    </table>

                    <h4 class="font-semibold text-gray-700 mt-6 mb-2">S3 Path and Filename Conventions:</h4>
                    <ul class="list-disc ml-5">
                        <li>
                            **ABI Products:**
                            <ul class="list-circle ml-5">
                                <li>**Full Disk (FD):** The S3 directory path will use `[BaseProductCode]F/` (e.g., `ABI-L1b-RadF/`).</li>
                                <li>**CONUS (C):** The S3 directory path will use `[BaseProductCode]C/` (e.g., `ABI-L1b-RadC/`).</li>
                                <li>**Mesoscale (M1/M2):** The S3 directory path will use `[BaseProductCode]M/` (e.g., `ABI-L1b-RadM/`).
                                    <ul class="list-square ml-5">
                                        <li>*Filename Filtering:* Within these `...M/` directories, the application further filters files to ensure they contain `M1-` or `M2-` in their name, corresponding to the selected Mesoscale region.
                                            <br>Example: `OR_ABI-L1b-RadM1-M6C01_G19_s20251541300281_e202515413003338_c20251541300390.nc`
                                        </li>
                                    </ul>
                                </li>
                            </ul>
                        </li>
                        <li>
                            **Non-ABI Products (GLM, SUVI, EXIS, MAG, SEIS):**
                            <ul class="list-circle ml-5">
                                <li>These products do **not** use regional suffixes in their S3 directory paths (e.g., `GLM-L2-LCFA/`, `SUVI-L1b-Fe093/`). The "Coverage Region" selection is automatically hidden when these product types are chosen.</li>
                            </ul>
                        </li>
                    </ul>
                </div>
            </details>
        </div>

        <div class="form-group mb-6">
            <label class="mb-2">Coverage Region:</label>
            <div id="coverageRegionRadios" class="radio-group coverage-region">
                </div>
        </div>

        <div id="channelSelectionGroup" class="form-group mb-6" style="display: none;">
            <label class="mb-2">Channel Selection (ABI Only):</label>
            <span class="text-sm text-gray-500 mb-2 block">If no channels are selected, all relevant channels for the product type will be included.</span>
            <div class="flex gap-2 mb-2">
                <button id="selectAllChannelsButton" class="btn-primary px-4 py-2 text-sm">Select All Channels</button>
                <button id="clearAllChannelsButton" class="btn-primary px-4 py-2 text-sm">Clear All Channels</button>
            </div>
            <div id="channelCheckboxes" class="channel-grid">
                </div>
        </div>

        <div class="form-group mb-6">
            <label for="dateInput" class="mb-2">Date (UTC):</label>
            <input type="date" id="dateInput" class="focus:ring-blue-500 focus:border-blue-500">
        </div>
        <div class="grid grid-cols-2 gap-6 mb-8">
            <div class="form-group">
                <label for="hourSelect" class="mb-2">Hour (UTC):</label>
                <select id="hourSelect" class="focus:ring-blue-500 focus:border-blue-500"></select>
            </div>
            <div class="form-group">
                <label for="minuteSelect" class="mb-2">Minute (UTC):</label>
                <select id="minuteSelect" class="focus:ring-blue-500 focus:border-blue-500"></select>
            </div>
        </div>

        <div class="form-group mb-6">
            <label for="timeDeltaSlider" class="mb-2 flex justify-between items-center">
                <span>Time Delta (Minutes):</span>
                <span id="timeDeltaValue" class="font-normal text-gray-600">15 min</span>
            </label>
            <input type="range" id="timeDeltaSlider" min="0" max="60" value="15" step="1" class="w-full h-2 bg-blue-100 rounded-lg appearance-none cursor-pointer range-lg focus:outline-none focus:ring-2 focus:ring-blue-400 focus:ring-opacity-75">
        </div>

        <div class="form-group mb-6">
            <label for="currentPrefix" class="mb-2">Generated S3 Prefix (for QC):</label>
            <div id="currentPrefix" class="results-area text-sm bg-gray-100 p-3 rounded-md break-words">
                </div>
        </div>

        <div id="myHDF5Instruction" class="bg-yellow-100 text-yellow-800 border border-yellow-300 rounded-lg p-4 mb-6">
            <p class="font-semibold mb-2">Tip for Viewing Files:</p>
            <p>Select a single file from the results and click the "Open in Sandbox" button. This will open the selected file in the NetCDF Raster Sandbox in a new tab for immediate visualization and analysis.</p>
        </div>

        <div class="flex flex-col sm:flex-row items-center justify-center gap-4 mb-8">
            <button id="queryButton" class="btn-primary flex items-center w-full sm:w-auto justify-center">
                Query S3
                <div id="loadingSpinner" class="loading-spinner"></div>
            </button>
            <button id="downloadButton" class="btn-primary flex items-center w-full sm:w-auto justify-center" style="display: none;">
                Download Selected Files
            </button>

            <button id="openSandboxButton" class="btn-primary flex items-center w-full sm:w-auto justify-center" style="display: none;">
                Open in Sandbox
            </button>
        </div>

        <div id="copyS3LinkGroup" class="form-group mb-6" style="display: none;">
            <label for="s3LinkInput" class="mb-2">S3 Object Link:</label>
            <div class="copy-link-group">
                <input type="text" id="s3LinkInput" readonly class="focus:ring-blue-500 focus:border-blue-500">
                <button id="copyLinkButton" class="btn-primary">Copy Link</button>
            </div>
        </div>
        <div id="errorMessage" class="error-message"></div>
        <div id="instructionMessage" class="error-message bg-green-100 text-green-700 border-green-300" style="display: none;"></div>


        <h2 class="text-xl font-semibold text-gray-700 mb-4">Results:</h2>
        <div id="results" class="results-area">
            Enter your query parameters and click "Query S3" to see results.
        </div>
        
        <div id="copyLinksPanel" class="hidden">
             <h3 class="text-lg font-semibold text-gray-700 mt-6 mb-3">Copy Object Key</h3>
             <p class="text-sm text-gray-600 mb-4">Copy the key for the selected file with your desired prefix.</p>
             <div class="copy-link-group">
                <span class="inline-flex items-center px-3 text-sm text-gray-900 bg-gray-200 border border-r-0 border-gray-300 rounded-l-md">https://</span>
                <input type="text" id="httpsLinkInput" readonly>
                <button id="copyHttpsLinkBtn" class="btn-primary">Copy</button>
            </div>
             <div class="copy-link-group">
                 <span class="inline-flex items-center px-3 text-sm text-gray-900 bg-gray-200 border border-r-0 border-gray-300 rounded-l-md">s3://</span>
                <input type="text" id="s3LinkInputNew" readonly>
                <button id="copyS3LinkBtn" class="btn-primary">Copy</button>
            </div>
        </div>

        <div id="jsonOutputPanel" class="hidden">
            <h3 class="text-lg font-semibold text-gray-700 mt-6 mb-3">Selected Files JSON</h3>
            <textarea id="jsonDisplayArea" readonly></textarea>
            <button id="copyJsonBtn" class="btn-primary w-full bg-gray-600 hover:bg-gray-700">Copy JSON to Clipboard</button>
        </div>
        <div class="text-center text-gray-600 text-sm mt-8 p-4 bg-white rounded-lg shadow-inner">
            <p class="mb-2">Files can also be viewed directly in your browser using <a href="https://myhdf5.hdfgroup.org/" target="_blank" class="text-blue-600 hover:text-blue-800 font-semibold transition-colors duration-200">myhdf5.hdfgroup.org</a>.</p>
            <p><a href="https://github.com/coliveir-aer/goes-data-explorer" target="_blank" class="text-blue-600 hover:text-blue-800 font-semibold transition-colors duration-200">GOES Data Explorer github</a></p>
        </div>
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', () => {
            const satelliteSelectionRadiosDiv = document.getElementById('satelliteSelectionRadios');
            const productTypeSelect = document.getElementById('productTypeSelect');
            const coverageRegionRadiosDiv = document.getElementById('coverageRegionRadios');
            const dateInput = document.getElementById('dateInput');
            const hourSelect = document.getElementById('hourSelect');
            const minuteSelect = document.getElementById('minuteSelect');
            const timeDeltaSlider = document.getElementById('timeDeltaSlider');
            const timeDeltaValueSpan = document.getElementById('timeDeltaValue');
            const queryButton = document.getElementById('queryButton');
            const downloadButton = document.getElementById('downloadButton');
            const openSandboxButton = document.getElementById('openSandboxButton');
            const resultsDiv = document.getElementById('results');
            const loadingSpinner = document.getElementById('loadingSpinner');
            const errorMessageDiv = document.getElementById('errorMessage');
            const instructionMessageDiv = document.getElementById('instructionMessage');
            const myHDF5InstructionDiv = document.getElementById('myHDF5Instruction');
            const currentPrefixDisplay = document.getElementById('currentPrefix');
            const channelSelectionGroup = document.getElementById('channelSelectionGroup');
            const channelCheckboxesDiv = document.getElementById('channelCheckboxes');
            const selectAllChannelsButton = document.getElementById('selectAllChannelsButton');
            const clearAllChannelsButton = document.getElementById('clearAllChannelsButton');
            
            const copyS3LinkGroup = document.getElementById('copyS3LinkGroup');
            const s3LinkInputOriginal = document.getElementById('s3LinkInput');
            const copyLinkButton = document.getElementById('copyLinkButton');

            // NEW DOM ELEMENT VARIABLES ADDED HERE
            const messageBox = document.createElement('div'); // Create a message box element
            messageBox.className = 'message-box opacity-0 hidden';
            document.querySelector('.container').appendChild(messageBox); // Add it to the container

            const copyLinksPanel = document.getElementById('copyLinksPanel');
            const httpsLinkInput = document.getElementById('httpsLinkInput');
            const s3LinkInputNew = document.getElementById('s3LinkInputNew'); // Changed this ID in HTML
            const copyHttpsLinkBtn = document.getElementById('copyHttpsLinkBtn');
            const copyS3LinkBtnNew = document.getElementById('copyS3LinkBtn'); // This is the button
            const jsonOutputPanel = document.getElementById('jsonOutputPanel');
            const jsonDisplayArea = document.getElementById('jsonDisplayArea');
            const copyJsonBtn = document.getElementById('copyJsonBtn');
            // END OF NEW DOM ELEMENT VARIABLES


            // Define available satellites (ordered: 16, 17, 18, 19, with 19 as default)
            const satellites = [
                { value: "noaa-goes16", label: "GOES-16" },
                { value: "noaa-goes17", label: "GOES-17" },
                { value: "noaa-goes18", label: "GOES-18" },
                { value: "noaa-goes19", label: "GOES-19" } // Default
            ];

            // Define base product types and their display names for the dropdown
            // The regional suffix (F, C, M) will be appended dynamically to these.
            const productTypes = [
                { "value": "ABI-L1b-Rad", "label": "ABI L1b Radiance" },
                { "value": "ABI-L2-ACHA", "label": "ABI L2 Cloud Top Height" },
                { "value": "ABI-L2-ACHA2KM", "label": "ABI L2 2km Cloud Height" },
                { "value": "ABI-L2-ACHP2KM", "label": "ABI L2 2km Cloud Pressure" },
                { "value": "ABI-L2-ACHT", "label": "ABI L2 Cloud Top Temperature" },
                { "value": "ABI-L2-ACM", "label": "ABI L2 Cloud Mask" },
                { "value": "ABI-L2-ACTP", "label": "ABI L2 Cloud Top Phase" },
                { "value": "ABI-L2-ADP", "label": "ABI L2 Aerosol Detection" },
                { "value": "ABI-L2-AICE", "label": "ABI L2 Ice Conc & Extent" },
                { "value": "ABI-L2-AITA", "label": "ABI L2 Ice Thickness & Age" },
                { "value": "ABI-L2-AOD", "label": "ABI L2 Aerosol Optical Depth" },
                { "value": "ABI-L2-BRF", "label": "ABI L2 Bidirectional Reflectance" },
                { "value": "ABI-L2-CCLC", "label": "ABI L2 Clear Sky Confidence" },
                { "value": "ABI-L2-CMIP", "label": "ABI L2 Cloud & Moisture Imagery" },
                { "value": "ABI-L2-COD", "label": "ABI L2 Cloud Optical Depth" },
                { "value": "ABI-L2-COD2KM", "label": "ABI L2 Cloud Optical Depth 2KM" },
                { "value": "ABI-L2-CPS", "label": "ABI L2 Cloud Particle Size" },
                { "value": "ABI-L2-CTP", "label": "ABI L2 Cloud Top Pressure" },
                { "value": "ABI-L2-DMW", "label": "ABI L2 Derived Motion Winds" },
                { "value": "ABI-L2-DMWV", "label": "ABI L2 Derived Motion Wind Vectors" },
                { "value": "ABI-L2-DSI", "label": "ABI L2 Derived Stability Indices" },
                { "value": "ABI-L2-DSR", "label": "ABI L2 Downward Shortwave Radiation" },
                { "value": "ABI-L2-FDC", "label": "ABI L2 Fire/Hot Spot" },
                { "value": "ABI-L2-FSC", "label": "ABI L2 Fractional Snow Cover" },
                { "value": "ABI-L2-LSA", "label": "ABI L2 Land Surface Albedo" },
                { "value": "ABI-L2-LST", "label": "ABI L2 Land Surface Temperature" },
                { "value": "ABI-L2-LST2KM", "label": "ABI L2 Land Surface Temperature 2KM" },
                { "value": "ABI-L2-LVMP", "label": "ABI L2 Legacy Vertical Moisture Profile" },
                { "value": "ABI-L2-LVTP", "label": "ABI L2 Legacy Vertical Temp Profile" },
                { "value": "ABI-L2-MCMIP", "label": "ABI L2 Imagery 16 Channel" },
                { "value": "ABI-L2-PAR", "label": "ABI L2 Photosynthetically Active Radiation" },
                { "value": "ABI-L2-RRQPE", "label": "ABI L2 Rainfall Rate QPE" },
                { "value": "ABI-L2-RSR", "label": "ABI L2 Reflected Shortwave Radiation Top-of-Atmosphere" },
                { "value": "ABI-L2-SST", "label": "ABI L2 Sea Surface Temperature" },
                { "value": "ABI-L2-TPW", "label": "ABI L2 Total Precipitable Water" },
                { "value": "EXIS-L1b-SFEU", "label": "EXIS L1b Solar Flux EUV" },
                { "value": "EXIS-L1b-SFXR", "label": "EXIS L1b Solar Flux X-Ray" },
                { "value": "GLM-L2-LCFA", "label": "GLM L2 Lightning" },
                { "value": "MAG-L1b-GEOF", "label": "MAG L1b Geomagnetic Field" },
                { "value": "SEIS-L1b-EHIS", "label": "SEIS L1b Energetic Heavy Ion Sensor" },
                { "value": "SEIS-L1b-MPSH", "label": "SEIS L1b Magnetospheric Particle Sensor High" },
                { "value": "SEIS-L1b-MPSL", "label": "SEIS L1b Magnetospheric Particle Sensor Low" },
                { "value": "SEIS-L1b-SGPS", "label": "SEIS L1b Solar and Galactic Proton Sensor" },
                { "value": "SUVI-L1b-Fe093", "label": "SUVI L1b Fe093" },
                { "value": "SUVI-L1b-Fe131", "label": "SUVI L1b Fe131" },
                { "value": "SUVI-L1b-Fe171", "label": "SUVI L1b Fe171" },
                { "value": "SUVI-L1b-Fe195", "label": "SUVI L1b Fe195" },
                { "value": "SUVI-L1b-Fe284", "label": "SUVI L1b Fe284" },
                { "value": "SUVI-L1b-He303", "label": "SUVI L1b He303" }
            ];

            // Define coverage regions (including Mesoscale 1 and 2)
            const coverageRegions = [
                { value: "fd", label: "Full Disk" },
                { value: "conus", label: "CONUS" },
                { value: "meso1", label: "Mesoscale 1" },
                { value: "meso2", label: "Mesoscale 2" }
            ];

            // Populate Satellite radio buttons
            satellites.forEach((sat, index) => {
                const input = document.createElement('input');
                input.type = 'radio';
                input.id = `satellite-${sat.value}`;
                input.name = 'satellite';
                input.value = sat.value;
                if (sat.value === "noaa-goes19") input.checked = true; // Set GOES-19 as default

                const label = document.createElement('label');
                label.htmlFor = `satellite-${sat.value}`;
                label.textContent = sat.label;

                satelliteSelectionRadiosDiv.appendChild(input);
                satelliteSelectionRadiosDiv.appendChild(label);
            });

            // Populate Product Type dropdown
            productTypes.forEach((type) => {
                const option = document.createElement('option');
                option.value = type.value;
                option.textContent = type.label;
                productTypeSelect.appendChild(option);
            });
            // Set default product type to ABI L2 Cloud Altitude (ABI-L2-ACHA)
            productTypeSelect.value = "ABI-L2-ACHA";

            // Populate Coverage Region radio buttons
            coverageRegions.forEach((region) => {
                const input = document.createElement('input');
                input.type = 'radio';
                input.id = `coverageRegion-${region.value}`;
                input.name = 'coverageRegion';
                input.value = region.value;
                // Set default coverage region to Full Disk
                if (region.value === "fd") {
                    input.checked = true;
                }

                const label = document.createElement('label');
                label.htmlFor = `coverageRegion-${region.value}`;
                label.textContent = region.label;

                coverageRegionRadiosDiv.appendChild(input);
                coverageRegionRadiosDiv.appendChild(label);
            });

            // Populate Channel checkboxes (1-16) - all are created, visibility controlled by JS
            for (let i = 1; i <= 16; i++) {
                const channelNum = String(i).padStart(2, '0');
                const input = document.createElement('input');
                input.type = 'checkbox';
                input.id = `channel-${channelNum}`;
                input.name = 'channel';
                input.value = channelNum;
                // Set default channel to 02 (Band 2)
                if (channelNum === "02") {
                    input.checked = true;
                }

                const label = document.createElement('label');
                label.htmlFor = `channel-${channelNum}`;
                label.textContent = channelNum;

                channelCheckboxesDiv.appendChild(input);
                channelCheckboxesDiv.appendChild(label);
            }

            // Populate Hour and Minute Selectors
            for (let i = 0; i < 24; i++) {
                const option = document.createElement('option');
                option.value = String(i).padStart(2, '0');
                option.textContent = String(i).padStart(2, '0');
                hourSelect.appendChild(option);
            }
            for (let i = 0; i < 60; i++) {
                const option = document.createElement('option');
                option.value = String(i).padStart(2, '0');
                option.textContent = String(i).padStart(2, '0');
                minuteSelect.appendChild(option);
            }

            // Set default date/time to 1 hour before current UTC time
            const nowUtc = new Date();
            nowUtc.setUTCHours(nowUtc.getUTCHours() - 1); // Subtract 1 hour
            nowUtc.setUTCMinutes(0); // Round down minutes to the nearest hour
            nowUtc.setUTCSeconds(0);
            nowUtc.setUTCMilliseconds(0);

            const defaultDate = nowUtc.toISOString().slice(0, 10); //YYYY-MM-DD
            const defaultHour = String(nowUtc.getUTCHours()).padStart(2, '0');
            const defaultMinute = String(nowUtc.getUTCMinutes()).padStart(2, '0');

            dateInput.value = defaultDate;
            hourSelect.value = defaultHour;
            minuteSelect.value = defaultMinute;

            // Initialize time delta slider and its display
            timeDeltaValueSpan.textContent = `${timeDeltaSlider.value} min`;
            timeDeltaSlider.addEventListener('input', () => {
                timeDeltaValueSpan.textContent = `${timeDeltaSlider.value} min`;
                updatePrefixDisplay(); // Update the prefix display to reflect time delta in QC prefix
            });

            // Function to get the current S3 prefix based on user selections (for the actual S3 query)
            function getCurrentS3QueryPrefix(dateObj, hour) { // Renamed for clarity and added parameters
                const selectedSatelliteRadio = document.querySelector('input[name="satellite"]:checked');
                const baseProductType = productTypeSelect.value;
                const selectedCoverageRegionRadio = document.querySelector('input[name="coverageRegion"]:checked');

                if (!selectedSatelliteRadio || (baseProductType.startsWith('ABI-L') && coverageRegionRadiosDiv.style.display !== 'none' && !selectedCoverageRegionRadio)) {
                    return null; // Return null if essential selections are missing
                }

                const year = dateObj.getUTCFullYear();
                // Calculate day of year
                const startOfYear = new Date(Date.UTC(year, 0, 1));
                const dayOfYear = Math.floor((dateObj.getTime() - startOfYear.getTime()) / (1000 * 60 * 60 * 24)) + 1;
                
                const coverageRegion = selectedCoverageRegionRadio ? selectedCoverageRegionRadio.value : 'N/A';

                let finalProductTypeForPrefix = baseProductType;
                // Append suffix based on coverage region for ABI products
                if (baseProductType.startsWith('ABI-L')) {
                    if (coverageRegion === 'fd') {
                        finalProductTypeForPrefix += 'F';
                    } else if (coverageRegion === 'conus') {
                        finalProductTypeForPrefix += 'C';
                    } else if (coverageRegion === 'meso1' || coverageRegion === 'meso2') {
                        finalProductTypeForPrefix += 'M'; // Mesoscale products use 'M' in the prefix path
                    }
                }
                // GLM, SUVI, EXIS, MAG, SEIS products do not get a suffix based on region in their product type path.

                return `${finalProductTypeForPrefix}/${year}/${String(dayOfYear).padStart(3, '0')}/${String(hour).padStart(2, '0')}/`;
            }

            // Function to update the displayed S3 prefix for QC (includes time delta info for user)
            function updatePrefixDisplay() {
                const selectedSatelliteRadio = document.querySelector('input[name="satellite"]:checked');
                const baseProductType = productTypeSelect.value;
                const selectedCoverageRegionRadio = document.querySelector('input[name="coverageRegion"]:checked');
                const dateVal = dateInput.value;
                const hourVal = hourSelect.value;
                const minuteVal = minuteSelect.value;
                const timeDelta = timeDeltaSlider.value;

                if (!selectedSatelliteRadio || (baseProductType.startsWith('ABI-L') && coverageRegionRadiosDiv.style.display !== 'none' && !selectedCoverageRegionRadio) || !dateVal || !hourVal || !minuteVal) {
                    currentPrefixDisplay.textContent = "Please make all selections to generate prefix.";
                    return;
                }

                // Create a temporary date object for prefix generation, using the selected date and hour
                const tempDateObj = new Date(`${dateVal}T${hourVal}:00:00Z`);
                const s3PathPrefix = getCurrentS3QueryPrefix(tempDateObj, parseInt(hourVal, 10)); // Pass tempDateObj and hour

                if (s3PathPrefix) {
                    currentPrefixDisplay.textContent = `${s3PathPrefix} (Filtering around ${hourVal}:${minuteVal} +/- ${timeDelta} min)`;
                } else {
                     currentPrefixDisplay.textContent = "Please make all selections to generate prefix.";
                }
            }

            // Function to extract time from GOES filename (e.g., OR_ABI-L1b-RadF-M6C01_G17_s20231640000210_e20231640000210_c20231640000302.nc)
            // It expects a filename and comes back with an object { year: number, dayOfYear: number, hour: number, minute: number, second: number } or null if not found
            function parseTimeFromFilename(filename) {
                // Regex to capture year, day of year, and HHMMSS from the 's' (start) timestamp
                const startTimeMatch = filename.match(/_s(\d{4})(\d{3})(\d{6})\d+/); 
                if (startTimeMatch) {
                    const year = parseInt(startTimeMatch[1], 10);
                    const dayOfYear = parseInt(startTimeMatch[2], 10);
                    const timeString = startTimeMatch[3]; // e.g., "000021"
                    const hour = parseInt(timeString.substring(0, 2), 10);
                    const minute = parseInt(timeString.substring(2, 4), 10);
                    const second = parseInt(timeString.substring(4, 6), 10);
                    
                    if (!isNaN(year) && !isNaN(dayOfYear) && !isNaN(hour) && !isNaN(minute) && !isNaN(second)) {
                        // Calculate date from year and dayOfYear to normalize
                        const date = new Date(Date.UTC(year, 0, dayOfYear)); // Month is 0-indexed, day is 1-indexed
                        return { year, dayOfYear, hour, minute, second, date };
                    }
                }
                return null;
            }

            // Function to show/hide and enable/disable specific channel selectors and coverage region
            function toggleChannelSelector() {
                const selectedProductType = productTypeSelect.value; // This is the base product type
                const allChannelLabels = document.querySelectorAll('#channelCheckboxes label'); // Select labels directly
                const relevantProductsForChannel = ["ABI-L1b-Rad", "ABI-L2-CMIP", "ABI-L2-DMW", "ABI-L2-DMWV"];
                const dMwChannels = ["02", "07", "08", "09", "10", "14"];

                // Toggle visibility of channel selection group
                if (relevantProductsForChannel.includes(selectedProductType)) {
                    channelSelectionGroup.style.display = 'block';

                    allChannelLabels.forEach(label => {
                        const checkbox = document.getElementById(label.htmlFor); // Get associated checkbox
                        if (selectedProductType === "ABI-L2-DMW" || selectedProductType === "ABI-L2-DMWV") {
                            // For DMW and DMWV, only show specific channels
                            if (dMwChannels.includes(checkbox.value)) {
                                label.style.display = 'flex'; // Show label
                                checkbox.disabled = false;
                            } else {
                                label.style.display = 'none'; // Hide label
                                checkbox.checked = false; // Uncheck hidden channels
                                checkbox.disabled = true;
                            }
                        } else {
                            // For other relevant products, show all channels
                            label.style.display = 'flex'; // Show label
                            checkbox.disabled = false;
                        }
                    });
                } else {
                    channelSelectionGroup.style.display = 'none';
                    // Hide and uncheck all channels when the section is hidden
                    allChannelLabels.forEach(label => {
                        const checkbox = document.getElementById(label.htmlFor);
                        label.style.display = 'none'; // Hide label
                        checkbox.checked = false;
                        checkbox.disabled = true;
                    });
                }

                // Toggle visibility of coverage region radios
                if (selectedProductType.startsWith('ABI-L')) {
                    coverageRegionRadiosDiv.style.display = 'flex'; // Show if it's an ABI product
                } else {
                    coverageRegionRadiosDiv.style.display = 'none'; // Hide if it's not an ABI product
                    // Ensure the default coverage region is selected when hiding the radios
                    const defaultCoverageRadio = document.getElementById('coverageRegion-fd');
                    if (defaultCoverageRadio) {
                        defaultCoverageRadio.checked = true;
                    }
                }
            }

            // Add event listeners to update prefix display and toggle channel selector on change
            satelliteSelectionRadiosDiv.addEventListener('change', updatePrefixDisplay);
            productTypeSelect.addEventListener('change', () => {
                updatePrefixDisplay();
                toggleChannelSelector();
            });
            coverageRegionRadiosDiv.addEventListener('change', updatePrefixDisplay);
            dateInput.addEventListener('change', updatePrefixDisplay);
            hourSelect.addEventListener('change', updatePrefixDisplay);
            minuteSelect.addEventListener('change', updatePrefixDisplay);

            // Initial display of prefix and channel selector state
            updatePrefixDisplay();
            toggleChannelSelector();


            queryButton.addEventListener('click', async () => {
                const selectedSatelliteRadio = document.querySelector('input[name="satellite"]:checked');
                const baseProductType = productTypeSelect.value;
                const selectedCoverageRegionRadio = document.querySelector('input[name="coverageRegion"]:checked');

                if (!selectedSatelliteRadio) {
                    displayError("Please select a Satellite (GOES-16, GOES-17, GOES-18, or GOES-19).");
                    return;
                }
                if (baseProductType.startsWith('ABI-L') && coverageRegionRadiosDiv.style.display !== 'none' && !selectedCoverageRegionRadio) {
                    displayError("Please select a Coverage Region.");
                    return;
                }

                const bucketName = selectedSatelliteRadio.value;
                const coverageRegion = selectedCoverageRegionRadio ? selectedCoverageRegionRadio.value : 'N/A';

                const dateVal = dateInput.value;
                const hourVal = hourSelect.value;
                const minuteVal = minuteSelect.value;
                const timeDelta = parseInt(timeDeltaSlider.value, 10);

                const selectedHour = parseInt(hourVal, 10);
                const selectedMinute = parseInt(minuteVal, 10);


                if (!dateVal || !hourVal || !minuteVal || isNaN(timeDelta)) {
                    displayError("Please ensure Date, Hour, Minute, and Time Delta are all selected.");
                    return;
                }
                
                // Construct the base Date object for the selected time
                const selectedDateTime = new Date(`${dateVal}T${hourVal}:${minuteVal}:00Z`);
                if (isNaN(selectedDateTime.getTime())) {
                    console.error("Invalid Date object from:", `${dateVal}T${hourVal}:${minuteVal}:00Z`);
                    displayError("Invalid date or time. Please verify your selections.");
                    return;
                }

                const s3Region = 'us-east-1';

                resultsDiv.innerHTML = 'Querying S3...';
                resultsDiv.classList.remove('text-red-500');
                hideError();
                hideInstruction();
                hideMyHDF5Instruction();
                hideCopyLinkSection(); // New: Hide copy link section on new query
                showLoading();
				
                copyLinksPanel.classList.add('hidden');
				jsonOutputPanel.classList.add('hidden');
                downloadButton.style.display = 'none';
                openSandboxButton.style.display = 'none';

                let allFoundKeys = [];
                let prefixesToQuery = new Set(); // Use a Set to store unique prefixes

                // Calculate the start and end times for the search window
                const searchWindowStart = new Date(selectedDateTime.getTime() - timeDelta * 60 * 1000);
                const searchWindowEnd = new Date(selectedDateTime.getTime() + timeDelta * 60 * 1000);

                // Add prefixes for the current hour
                prefixesToQuery.add(getCurrentS3QueryPrefix(selectedDateTime, selectedDateTime.getUTCHours()));

                // Check if the search window extends into the previous hour
                if (searchWindowStart.getUTCHours() !== selectedDateTime.getUTCHours()) {
                    prefixesToQuery.add(getCurrentS3QueryPrefix(searchWindowStart, searchWindowStart.getUTCHours()));
                }

                // Check if the search window extends into the next hour
                if (searchWindowEnd.getUTCHours() !== selectedDateTime.getUTCHours()) {
                    prefixesToQuery.add(getCurrentS3QueryPrefix(searchWindowEnd, searchWindowEnd.getUTCHours()));
                }

                // Remove any null prefixes that might have been added due to missing selections
                const validPrefixes = Array.from(prefixesToQuery).filter(p => p !== null);

                console.log(`Attempting to query S3 for:`);
                console.log(`  Satellite: ${selectedSatelliteRadio.label}`);
                console.log(`  Base Product Type (dropdown): ${baseProductType}`);
                console.log(`  Coverage Region: ${coverageRegion}`);
                console.log(`  Bucket: ${bucketName}, Region: ${s3Region}`);
                console.log(`  Calculated Prefixes to Query:`, validPrefixes);

                try {
                    for (const prefix of validPrefixes) {
                        let continuationToken = undefined;
                        let isTruncated = true;

                        while (isTruncated) {
                            let url = `https://${bucketName}.s3.${s3Region}.amazonaws.com/?list-type=2&prefix=${encodeURIComponent(prefix)}`;
                            if (continuationToken) {
                                url += `&continuation-token=${encodeURIComponent(continuationToken)}`;
                            }

                            console.log(`Fetching URL: ${url}`);
                            const response = await fetch(url);

                            if (!response.ok) {
                                const errorText = await response.text();
                                throw new Error(`HTTP error! Status: ${response.status}, Body: ${errorText}`);
                            }

                            const responseText = await response.text();
                            // console.log("Raw S3 XML Response:", responseText); // Too verbose, uncomment for deep debugging
                            
                            const parser = new DOMParser();
                            const xmlDoc = parser.parseFromString(responseText, "application/xml");

                            const errorNode = xmlDoc.querySelector('Error');
                            if (errorNode) {
                                const errorCode = errorNode.querySelector('Code')?.textContent;
                                const errorMessage = errorNode.querySelector('Message')?.textContent;
                                throw new Error(`S3 Error: ${errorCode} - ${errorMessage}`);
                            }

                            const contents = xmlDoc.querySelectorAll('Contents');
                            // console.log(`Found ${contents.length} 'Contents' nodes in XML for prefix: ${prefix}.`); // Too verbose
                            
                            contents.forEach(item => {
                                const key = item.querySelector('Key')?.textContent;
                                if (key) {
                                    allFoundKeys.push(key);
                                    // console.log(`  Found key: ${key}`); // Too verbose
                                }
                            });

                            const isTruncatedNode = xmlDoc.querySelector('IsTruncated');
                            isTruncated = isTruncatedNode && isTruncatedNode.textContent === 'true';
                            // console.log(`IsTruncated for prefix ${prefix}: ${isTruncated}`); // Too verbose

                            const nextContinuationTokenNode = xmlDoc.querySelector('NextContinuationToken');
                            continuationToken = nextContinuationTokenNode ? nextContinuationTokenNode.textContent : undefined;
                            // console.log(`NextContinuationToken for prefix ${prefix}: ${continuationToken}`); // Too verbose
                        }
                    }

                    // Remove duplicate keys if any (due to querying multiple prefixes that might overlap slightly)
                    allFoundKeys = Array.from(new Set(allFoundKeys));

                    console.log("--- All unique keys found from S3 (before client-side filtering): ---");
                    allFoundKeys.forEach(key => console.log(key));
                    console.log(`Total unique keys found: ${allFoundKeys.length}`);
                    console.log("----------------------------------------------------------");

                    // CLIENT-SIDE FILTERING: Apply time delta filtering to the full list of keys
                    let keysToDisplay = allFoundKeys.filter(key => {
                        const filename = key.split('/').pop();
                        const timeInFilename = parseTimeFromFilename(filename);

                        if (timeInFilename) {
                            // Reconstruct full UTC date object for the file's timestamp
                            const fileDateTime = new Date(Date.UTC(timeInFilename.year, 0, timeInFilename.dayOfYear, timeInFilename.hour, timeInFilename.minute, timeInFilename.second));
                            
                            // Check if the file's time falls within the allowed delta range
                            return fileDateTime.getTime() >= searchWindowStart.getTime() && fileDateTime.getTime() <= searchWindowEnd.getTime();
                        }
                        console.warn(`Could not parse time from filename: ${filename}`); // Log if parsing fails
                        return false; // Filter out keys where time parsing failed
                    });
                    console.log(`Filtered by time delta (${timeDelta} min around ${selectedHour}:${selectedMinute}). Original ${allFoundKeys.length}, Filtered ${keysToDisplay.length} keys.`);
                    
                    // Apply Mesoscale filtering (still needed even after time delta)
                    if (baseProductType.startsWith('ABI-L') && (coverageRegion === 'meso1' || coverageRegion === 'meso2')) {
                        const targetMesoscaleSuffix = coverageRegion === 'meso1' ? 'M1-' : 'M2-';
                        const originalCount = keysToDisplay.length;
                        keysToDisplay = keysToDisplay.filter(key => {
                            // Check if the key contains the specific Mesoscale suffix in its filename
                            // This assumes filename part is at the end of the key path after the last '/'
                            const filenamePart = key.split('/').pop();
                            return filenamePart && filenamePart.includes(`${baseProductType}${targetMesoscaleSuffix}`);
                        });
                        console.log(`Filtered for Mesoscale ${targetMesoscaleSuffix.replace('-', '')} with pattern: ${baseProductType}${targetMesoscaleSuffix}. Reduced from ${originalCount} to ${keysToDisplay.length} keys.`);
                    } else {
                        console.log("No Mesoscale M1/M2 filename filtering applied.");
                    }

                    // Apply Channel filtering
                    const selectedChannels = Array.from(document.querySelectorAll('#channelCheckboxes input[type="checkbox"]:checked'))
                                                .map(cb => cb.value);
                    const relevantProductsForChannel = ["ABI-L1b-Rad", "ABI-L2-CMIP", "ABI-L2-DMW", "ABI-L2-DMWV"];

                    if (relevantProductsForChannel.includes(baseProductType) && selectedChannels.length > 0) {
                        const originalCount = keysToDisplay.length;
                        keysToDisplay = keysToDisplay.filter(key => {
                            return selectedChannels.some(channel => key.includes(`C${channel}_`));
                        });
                        console.log(`Filtered for channels: ${selectedChannels.join(', ')}. Reduced from ${originalCount} to ${keysToDisplay.length} keys.`);
                    } else if (relevantProductsForChannel.includes(baseProductType) && selectedChannels.length === 0 && channelSelectionGroup.style.display === 'block') {
                        console.log("Channel selector visible but no channels selected. Displaying all relevant keys for this product type.");
                    } else {
                        console.log("Channel filtering not applicable for this product type.");
                    }


                    hideLoading();
                    if (keysToDisplay.length > 0) {
                        displayResults(keysToDisplay);
                        downloadButton.style.display = 'flex';
                        openSandboxButton.style.display = 'flex';
                        showMyHDF5Instruction();
                        updateCopyLinkSection(); // New: Update copy link section after displaying results
                    } else {
                        displayResults("No object keys found for the specified criteria within the selected time window. Please double-check the date/time, product type, and time delta. Data for the very latest hours might not be immediately available. You can check NOAA's GOES data availability for more info.");
                        openSandboxButton.style.display = 'none';
                        hideMyHDF5Instruction();
                        hideCopyLinkSection(); // New: Hide copy link section if no results
                    }

                } catch (error) {
                    hideLoading();
                    console.error("Error querying S3:", error);
                    displayError(`Failed to query S3: ${error.message || "An unknown error occurred."}`);
                    openSandboxButton.style.display = 'none';
                    hideMyHDF5Instruction();
                    hideCopyLinkSection(); // New: Hide copy link section on error
                }
            });

            downloadButton.addEventListener('click', async () => {
                const selectedCheckboxes = resultsDiv.querySelectorAll('input[type="checkbox"]:checked');
                if (selectedCheckboxes.length === 0) {
                    displayError("Please select at least one file to download.");
                    return;
                }

                hideError();
                hideInstruction();
                hideMyHDF5Instruction();
                hideCopyLinkSection(); // New: Hide copy link section on download

                if (selectedCheckboxes.length > 1) {
                    resultsDiv.innerHTML = `<div class="text-blue-600 font-medium mb-4">Starting ${selectedCheckboxes.length} downloads... Please check your browser's download bar or pop-up blocker if you don't see them.</div>`;
                    setTimeout(() => {
                        const currentKeys = Array.from(resultsDiv.querySelectorAll('.selectable-list-item label')).map(label => label.textContent);
                        displayResults(currentKeys);
                        // Re-evaluate copy link after results are re-displayed
                        updateCopyLinkSection(); 
                    }, 3000);
                }


                for (let i = 0; i < selectedCheckboxes.length; i++) {
                    const checkbox = selectedCheckboxes[i];
                    const s3Key = checkbox.value;
                    const selectedSatelliteRadio = document.querySelector('input[name="satellite"]:checked');
                    const bucketName = selectedSatelliteRadio ? selectedSatelliteRadio.value : 'noaa-goes19';
                    const s3Region = 'us-east-1';
                    const downloadUrl = `https://${bucketName}.s3.${s3Region}.amazonaws.com/${s3Key}`;
                    
                    const link = document.createElement('a');
                    link.href = downloadUrl;
                    link.target = '_blank';
                    link.download = s3Key.split('/').pop();
                    document.body.appendChild(link);
                    link.click();
                    document.body.removeChild(link);

                    if (i < selectedCheckboxes.length - 1) {
                        await new Promise(resolve => setTimeout(resolve, 200));
                    }
                }
            });

	    // Event listener for the new "Select All Channels" button
            selectAllChannelsButton.addEventListener('click', () => {
                const channelCheckboxes = channelCheckboxesDiv.querySelectorAll('input[type="checkbox"]');
                channelCheckboxes.forEach(cb => {
                    if (!cb.disabled) { // Only select if not disabled by product type
                        cb.checked = true;
                    }
                });
                updatePrefixDisplay(); // Update prefix if channel selection affects it
            });

            // Event listener for the new "Clear All Channels" button
            clearAllChannelsButton.addEventListener('click', () => {
                const channelCheckboxes = channelCheckboxesDiv.querySelectorAll('input[type="checkbox"]');
                channelCheckboxes.forEach(cb => {
                    cb.checked = false;
                });
                updatePrefixDisplay(); // Update prefix if channel selection affects it
            });

            // Event listener for the "Open in Sandbox" button
            openSandboxButton.addEventListener('click', () => {
                const selectedCheckboxes = resultsDiv.querySelectorAll('input[type="checkbox"]:checked');
                if (selectedCheckboxes.length !== 1) {
                    displayError("Please select exactly ONE file to open in the sandbox.");
                    return;
                }

                hideError();
                hideInstruction();
                hideCopyLinkSection(); 

                const checkbox = selectedCheckboxes[0];
                const s3Key = checkbox.value;
                const selectedSatelliteRadio = document.querySelector('input[name="satellite"]:checked');
                const bucketName = selectedSatelliteRadio ? selectedSatelliteRadio.value : 'noaa-goes19';
                const s3Region = 'us-east-1';
                const fileUrl = `https://${bucketName}.s3.${s3Region}.amazonaws.com/${s3Key}`;
                const sandboxBaseUrl = 'https://coliveir-aer.github.io/netcdf-react-experiment/';

                // URL-encode the S3 file URL to make it a valid query parameter
                const encodedFileUrl = encodeURIComponent(fileUrl);
                const sandboxUrl = `${sandboxBaseUrl}?fileUrl=${encodedFileUrl}`;
                
                // Open the sandbox in a new tab with the direct view URL
                window.open(sandboxUrl, '_blank');
            });

            // Event listener for Copy Link button
            copyLinkButton.addEventListener('click', async () => {
                try {
                    await navigator.clipboard.writeText(s3LinkInputOriginal.value);
                    displayInstruction("Link copied to clipboard!");
                    setTimeout(hideInstruction, 3000); // Hide message after 3 seconds
                } catch (err) {
                    console.error('Failed to copy: ', err);
                    displayError('Failed to copy link to clipboard. Please copy manually.');
                }
            });

            // Event listener for changes within resultsDiv (to update copy link section)
            resultsDiv.addEventListener('change', (event) => {
                if (event.target.type === 'checkbox') {
                    updateCopyLinkSection();
                }
            });


            function displayResults(keys) {
                resultsDiv.innerHTML = '';
                if (Array.isArray(keys) && keys.length > 0) {
                    // Create a "Select All / Deselect All" button for the results
                    const selectAllResultsBtn = document.createElement('button');
                    selectAllResultsBtn.textContent = 'Select All';
                    selectAllResultsBtn.className = 'btn-primary px-4 py-2 text-sm mb-4';
                    selectAllResultsBtn.addEventListener('click', () => {
                        const checkboxes = resultsDiv.querySelectorAll('input[type="checkbox"]');
                        const allChecked = Array.from(checkboxes).every(cb => cb.checked);
                        checkboxes.forEach(cb => cb.checked = !allChecked);
                        selectAllResultsBtn.textContent = allChecked ? 'Select All' : 'Deselect All';
                        updateSelectionPanels();
                    });
                    resultsDiv.appendChild(selectAllResultsBtn);

                    keys.forEach(key => {
                        const itemDiv = document.createElement('div');
                        itemDiv.className = 'selectable-list-item';

                        const checkbox = document.createElement('input');
                        checkbox.type = 'checkbox';
                        checkbox.value = key;
                        checkbox.id = `key-${key.replace(/[^a-zA-Z0-9]/g, '_')}`;
                        // ADDED EVENT LISTENER HERE
                        checkbox.addEventListener('change', updateSelectionPanels);

                        const label = document.createElement('label');
                        label.htmlFor = checkbox.id;
                        label.textContent = key;
                        label.style.cursor = 'pointer';

                        itemDiv.appendChild(checkbox);
                        itemDiv.appendChild(label);
                        resultsDiv.appendChild(itemDiv);
                    });
                } else if (typeof keys === 'string') {
                    resultsDiv.textContent = keys;
                } else {
                    resultsDiv.textContent = "No object keys found for the specified criteria.";
                }
                // NEW: Call to update panels after displaying results
                updateSelectionPanels();
            }

            function showLoading() {
                queryButton.disabled = true;
                loadingSpinner.style.display = 'block';
            }

            function hideLoading() {
                queryButton.disabled = false;
                loadingSpinner.style.display = 'none';
            }

            function displayError(message) {
                errorMessageDiv.textContent = message;
                errorMessageDiv.style.display = 'block';
                resultsDiv.innerHTML = '';
                downloadButton.style.display = 'none';
                openSandboxButton.style.display = 'none';
                hideLoading();
                hideInstruction();
                hideMyHDF5Instruction();
                hideCopyLinkSection(); // New: Hide copy link section on error
            }

            function hideError() {
                errorMessageDiv.style.display = 'none';
                errorMessageDiv.textContent = '';
            }

            function showMessage(message, type) {
                messageBox.textContent = message;
                messageBox.className = `message-box p-4 rounded-lg opacity-100 ${
                    type === 'success' ? 'bg-green-100 text-green-700' : 'bg-blue-100 text-blue-700'
                }`;
                messageBox.classList.remove('hidden');
                setTimeout(() => {
                    messageBox.classList.add('opacity-0');
                    setTimeout(() => messageBox.classList.add('hidden'), 300);
                }, 3000);
            }

            async function copyToClipboard(text, typeName) {
                if (!text) {
                    showMessage(`No ${typeName} to copy.`, 'info');
                    return;
                }
                try {
                    await navigator.clipboard.writeText(text);
                    showMessage(`${typeName} copied to clipboard!`, 'success');
                } catch (err) {
                    console.error('Failed to copy to clipboard:', err);
                    displayError('Failed to copy. Your browser might not support this feature.');
                }
            }
			
            function displayInstruction(message) {
                instructionMessageDiv.textContent = message;
                instructionMessageDiv.style.display = 'block';
            }

            function hideInstruction() {
                instructionMessageDiv.style.display = 'none';
                instructionMessageDiv.textContent = '';
            }

            function showMyHDF5Instruction() {
                myHDF5InstructionDiv.style.display = 'block';
            }

            function hideMyHDF5Instruction() {
                myHDF5InstructionDiv.style.display = 'none';
            }
			
            function updateCopyLinkSection() {
                const selectedCheckboxes = resultsDiv.querySelectorAll('input[type="checkbox"]:checked');
                const selectedSatelliteRadio = document.querySelector('input[name="satellite"]:checked');
                const bucketName = selectedSatelliteRadio ? selectedSatelliteRadio.value : 'noaa-goes19';
                const s3Region = 'us-east-1';

                if (selectedCheckboxes.length === 1) {
                    const s3Key = selectedCheckboxes[0].value;
                    const fileUrl = `https://${bucketName}.s3.${s3Region}.amazonaws.com/${s3Key}`;
                    s3LinkInputOriginal.value = fileUrl;
                    copyS3LinkGroup.style.display = 'block';
                } else {
                    hideCopyLinkSection();
                }
            }
            
            function hideCopyLinkSection() {
                copyS3LinkGroup.style.display = 'none';
                if (s3LinkInputOriginal) {
                    s3LinkInputOriginal.value = '';
                }
            }
            
            function updateSelectionPanels() {
                const selectedCheckboxes = resultsDiv.querySelectorAll('input[type="checkbox"]:checked');
                const numSelected = selectedCheckboxes.length;
                const bucket = document.querySelector('input[name="satellite"]:checked').value;

                copyLinksPanel.classList.toggle('hidden', numSelected !== 1);
                jsonOutputPanel.classList.toggle('hidden', numSelected < 1); // BUG FIX: Show if 1 or more are selected

                if (numSelected === 1) {
                    const key = selectedCheckboxes[0].value;
                    httpsLinkInput.value = `${bucket}.s3.amazonaws.com/${key}`;
                    s3LinkInputNew.value = `${bucket}/${key}`;
                }
                
                // BUG FIX: Populate JSON if 1 or more are selected
                if (numSelected >= 1) {
                    const keys = Array.from(selectedCheckboxes).map(cb => cb.value);
                    jsonDisplayArea.value = JSON.stringify({
                        http_prefix: `https://${bucket}.s3.amazonaws.com/`,
                        s3_bucket: bucket,
                        keys: keys
                    }, null, 2);
                }
            }
            
            // Prepend the protocol/prefix to the value before copying
            copyHttpsLinkBtn.addEventListener('click', () => copyToClipboard('https://' + httpsLinkInput.value, 'HTTPS link'));
            copyS3LinkBtnNew.addEventListener('click', () => copyToClipboard('s3://' + s3LinkInputNew.value, 'S3 URI'));
            copyJsonBtn.addEventListener('click', () => copyToClipboard(jsonDisplayArea.value, 'JSON'));
        });
    </script>
</body>
</html>
